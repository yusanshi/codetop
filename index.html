<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>CodeTop</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"
      integrity="sha256-7Oajx7nIkYTg7DngGkbQPeZYOGF2y0Q3R24+vhzH/2M="
      crossorigin="anonymous"
    />

    <style>
      .easy {
        color: #15bd66;
      }

      .medium {
        color: #ffb800;
      }

      .hard {
        color: #ff334b;
      }

      .table {
        --bs-table-striped-bg: rgba(0, 0, 0, 0.03);
        text-align: center;
      }

      .container {
        max-width: 900px;
      }

      @media (max-width: 767.98px) {
        body {
          font-size: 14px;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <table id="table"></table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"
      integrity="sha256-lbFlaLNwCuK7kAmwDyvE47sfL7Qd8Jz1w8ubDRQKgag="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/arrive@2.4.1/minified/arrive.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/underscore@1.13.6/underscore-min.min.js"></script>

    <script>
      const params = new URL(document.location).searchParams;
      const endpoint = params.get('endpoint');
      const bearer = params.get('bearer');

      async function loadStorage() {
        let storage;
        if (endpoint === null || bearer == null) {
          console.log(
            'Endpoint or bearer not provided. Use local storage instead.'
          );
          storage = localStorage.getItem('storage');

          if (storage === null) {
            storage = {};
            console.log('Local storage empty');
          } else {
            storage = JSON.parse(storage);
            console.log('Load local storage', storage);
          }
          return storage;
        }

        console.log('Endpoint or bearer provided. Use online storage.');
        const response = await fetch(
          `https://${endpoint}.kv.vercel-storage.com/hgetall/storage`,
          {
            headers: {
              Authorization: `Bearer ${bearer}`,
            },
          }
        )
          .then((response) => {
            if (response.ok) {
              return response.json();
            }
            throw new Error(response.status);
          })
          .catch((error) => {
            alert('Error fetching online storage ' + error);
          });

        const array = response['result'];
        storage = Object.fromEntries(
          [...Array(array.length / 2).keys()].map((i) => [
            array[2 * i],
            parseInt(array[2 * i + 1]),
          ])
        );
        if (Object.keys(storage).length === 0) {
          console.log('Online storage empty');
        } else {
          console.log('Load online storage', storage);
        }
        return storage;
      }

      /**
       * @param {object} storage The full data to sava
       * @param {string} key The currently changed key
       */
      function saveStorage({ storage, key }) {
        if (endpoint === null || bearer == null) {
          localStorage.setItem('storage', JSON.stringify(storage));
        } else {
          fetch(`https://${endpoint}.kv.vercel-storage.com/`, {
            headers: {
              Authorization: `Bearer ${bearer}`,
            },
            body: JSON.stringify(['HSET', 'storage', key, storage[key]]),
            method: 'POST',
          });
        }
      }

      // https://stackoverflow.com/questions/28787436/debounce-a-function-with-argument
      const debounceByParam = (targetFunc, resolver, ...debounceParams) =>
        _.wrap(
          _.memoize(() => _.debounce(targetFunc, ...debounceParams), resolver),
          (getMemoizedFunc, ...params) => getMemoizedFunc(...params)(...params)
        );
      const saveStorageDebounced = debounceByParam(
        saveStorage,
        _.property('key'),
        1000
      );

      function setStyle(element, status) {
        const indeterminateMap = { 0: false, 1: true, 2: false };
        const checkedMap = { 0: false, 1: false, 2: true };
        const opacityMap = { 0: 1, 1: 0.4, 2: 0.15 };

        element.indeterminate = indeterminateMap[status];
        element.checked = checkedMap[status];
        const rowElement = element.parentNode.parentNode;
        rowElement.querySelectorAll('td').forEach((td) => {
          if (td.querySelectorAll('input').length == 0) {
            td.style.opacity = opacityMap[status];
          }
        });
      }

      const loadStoragePromise = loadStorage();
      const loadDataPromise = fetch('data.json').then((r) => r.json());

      window.addEventListener('DOMContentLoaded', async () => {
        const storage = await loadStoragePromise;
        const data = await loadDataPromise;

        document
          .querySelector('#table')
          .arrive('input.form-check-input', (element) => {
            // load and set status from storage
            const key = element.getAttribute('data-key');
            setStyle(element, storage[key] === undefined ? 0 : storage[key]);

            element.addEventListener('click', () => {
              // save status change into storage
              if (storage[key] === undefined) {
                storage[key] = 0;
              }
              storage[key] = (storage[key] + 1) % 3;
              console.log(`Set ${key} to ${storage[key]}`);
              setStyle(element, storage[key]);
              saveStorageDebounced({ storage, key });
            });
          });

        const levelMap = { easy: '简单', medium: '中等', hard: '困难' };

        $('#table').bootstrapTable({
          pagination: true,
          search: true,
          pageSize: 50,
          pageList: [20, 50, 100, 200, 'all'],
          classes: 'table table-bordered table-hover table-striped',
          searchHighlight: true,
          columns: [
            {
              field: 'id',
              title: '序号',
            },
            {
              field: 'titleHTML',
              title: '题目',
            },
            {
              field: 'levelHTML',
              title: '难度',
            },
            {
              field: 'frequency',
              title: '次数',
            },
            {
              field: 'doneHTML',
              title: '完成',
            },
          ],
          data: data.map((e) => ({
            ...e,
            levelHTML: `<span class="${e.level}">${levelMap[e.level]}</span>`,
            titleHTML:
              e.url !== null
                ? `<a target="_blank" class="link-dark" href="${e.url}">${e.leetcode_id}. ${e.title}</a>`
                : `<span class="link-dark">${e.leetcode_id}. ${e.title}</span>`,
            // set the status of checkboxes in `arrive('input.form-check-input', ....`
            doneHTML: `<input class="form-check-input" type="checkbox" data-key="${e.leetcode_id}. ${e.title}">`,
          })),
        });
      });

      window.addEventListener('keydown', (event) => {
        if (
          event.code === 'F3' ||
          ((event.ctrlKey || event.metaKey) && event.code === 'KeyF')
        ) {
          event.preventDefault();
          const input = document.querySelector(
            'div.bootstrap-table div.fixed-table-toolbar input.search-input'
          );
          input.focus();
          input.select();
        }
      });
    </script>
  </body>
</html>
